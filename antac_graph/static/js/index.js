let data = {
  "id": 1857809,
  "name": "ГАГАРІНСЬКА РАЙОННА У М. СЕВАСТОПОЛІ ОРГАНІЗАЦІЯ ПОЛІТИЧНОЇ ПАРТІЇ \"НОВА ДЕМОКРАТІЯ\"",
  "edrpou": '1235546',
  "short_name": "ПАРТІЯ \"НОВА ДЕМОКРАТІЯ\"",
  "company_type": "ПОЛІТИЧНА ПАРТІЯ",
  "bylaw": "діє на підставі установчих документів, затверджених засновниками (учасниками)",
  "status": "зареєстровано",
  "authority": "Відділ державної реєстрації юридичних осіб та фізичних осіб - підприємців Ленінського району реєстраційної служби Головного управління юстиції у місті Севастополі",
  "children": [
    {
      "id": 1857810,
      "name": "ПРИВАТНЕ ПІДПРИЄМСТВО \"ШЕЛЬФ\"",
      "edrpou": '1235546',
      "short_name": "ПП\"ШЕЛЬФ\"",
      "company_type": "ПРИВАТНЕ ПІДПРИЄМСТВО",
      "bylaw": "діє на підставі установчих документів, затверджених засновниками (учасниками)",
      "status": "зареєстровано",
      "authority": "Відділ державної реєстрації юридичних осіб та фізичних осіб - підприємців Ленінського району реєстраційної служби Головного управління юстиції у місті Севастополі",
    },
    {
      "id": 1857811,
      "name": "СЕВАСТОПОЛЬСЬКА МІСЬКА ПАРТІЙНА ОРГАНІЗАЦІЯ ВСЕУКРАЇНСЬКОЇ ПАРТІЇ ТРУДЯЩИХ",
      "edrpou": '1235546',
      "short_name": "ПП\"СПТ\"",
      "company_type": "ПОЛІТИЧНА ПАРТІЯ",
      "bylaw": "діє на підставі установчих документів, затверджених засновниками (учасниками)",
      "status": "зареєстровано",
      "authority": "Відділ державної реєстрації юридичних осіб та фізичних осіб - підприємців Ленінського району реєстраційної служби Головного управління юстиції у місті Севастополі",
    },
    {
      "id": 1857812,
      "name": "ТОВАРИСТВО З ОБМЕЖЕНОЮ ВІДПОВІДАЛЬНІСТЮ \"БУДВЕРТИКАЛЬ\"",
      "edrpou": '1235546',

      "short_name": "ТОВ \"БУДВЕРТИКАЛЬ\"",
      "company_type": "ТОВАРИСТВО З ОБМЕЖЕНОЮ ВІДПОВІДАЛЬНІСТЮ",
      "bylaw": "діє на підставі установчих документів, затверджених засновниками (учасниками)",
      "status": "припинено",
      "authority": "Відділ державної реєстрації юридичних осіб та фізичних осіб - підприємців Ленінського району реєстраційної служби Головного управління юстиції у місті Севастополі",
    },
    {
      "id": 1857813,
      "name": "ТОВАРИСТВО З ОБМЕЖЕНОЮ ВІДПОВІДАЛЬНІСТЮ \"ТЕХПРОМ\"",
      "edrpou": '1235546',
      "short_name": "ТОВ \"ТЕХПРОМ\"",
      "company_type": "ТОВАРИСТВО З ОБМЕЖЕНОЮ ВІДПОВІДАЛЬНІСТЮ",
      "bylaw": "діє на підставі установчих документів, затверджених засновниками (учасниками)",
      "status": "припинено",
      "authority": "Відділ державної реєстрації юридичних осіб та фізичних осіб - підприємців Ленінського району реєстраційної служби Головного управління юстиції у місті Севастополі",
    },
    {
      "id": 1857814,
      "name": "ПРИВАТНЕ ПІДПРИЄМСТВО \"РЕЗОНАНС\"",
      "edrpou": '1235546',
      "short_name": "ПП \"РЕЗОНАНС\"",
      "company_type": "ПРИВАТНЕ ПІДПРИЄМСТВО",
      "bylaw": "діє на підставі установчих документів, затверджених засновниками (учасниками)",
      "status": "припинено",
      "authority": "Відділ державної реєстрації юридичних осіб та фізичних осіб - підприємців Ленінського району реєстраційної служби Головного управління юстиції у місті Севастополі",
    },
    {
      "id": 1857815,
      "name": "ПРИВАТНЕ ПІДПРИЄМСТВО \"НАУКОВО - ВИРОБНИЧА КОМЕРЦІЙНА КОМПАНІЯ \" МЕЦЕНАТ\"",
      "edrpou": '1235546',
      "short_name": "ПП \"НВКК \"МЕЦЕНАТ\"",
      "company_type": "ПРИВАТНЕ ПІДПРИЄМСТВО",
      "bylaw": "діє на підставі установчих документів, затверджених засновниками (учасниками)",
      "status": "припинено",
      "authority": "Відділ державної реєстрації юридичних осіб та фізичних осіб - підприємців Гагарінського району реєстраційної служби Головного управління юстиції у місті Севастополі",
    },
    {
      "id": 1857816,
      "name": "ПРИВАТНЕ ПІДПРИЄМСТВО \"БИОС\"",
      "edrpou": '1235546',

      "short_name": "ПП \"БИОС\"",
      "company_type": "ПРИВАТНЕ ПІДПРИЄМСТВО",
      "bylaw": "діє на підставі установчих документів, затверджених засновниками (учасниками)",
      "status": "припинено",
      "authority": "Відділ державної реєстрації юридичних осіб та фізичних осіб - підприємців Ленінського району реєстраційної служби Головного управління юстиції у місті Севастополі",
    },
    {
      "id": 1857817,
      "name": "УПРАВЛІННЯ ВОДНОГО ГОСПОДАРСТВА СЕВАСТОПОЛЬСЬКОЇ МІСЬКОЇ АДМІНІСТРАЦІЇ",
      "edrpou": '1235546',
      "short_name": "УВГ СМДА",
      "company_type": "ОРГАН ДЕРЖАВНОЇ ВЛАДИ",
      "bylaw": "діє на підставі установчих документів, затверджених засновниками (учасниками)",
      "status": "припинено",
      "authority": "Відділ державної реєстрації юридичних осіб та фізичних осіб - підприємців Ленінського району реєстраційної служби Головного управління юстиції у місті Севастополі",
    },
    {
      "id": 1857818,
      "name": "\"ТЕЛЕКОМІНВЕСТ-ТАВРІЯ\"",
      "edrpou": '1235546',
      "short_name": "ЗАТ \"ТЕЛЕКОМІНВЕСТ-ТАВРІЯ\"",
      "company_type": "ЗАКРИТЕ АКЦІОНЕРНЕ ТОВАРИСТВО",
      "bylaw": "діє на підставі установчих документів, затверджених засновниками (учасниками)",
      "status": "припинено",
      "authority": "Департамент реєстраційних послуг Запорізької міської ради",
    },
  ],
};


let additionalData1 = [
  {
    "id": 1857819,
    "name": "ЖОВТНЕВЕ РАЙОННЕ УПРАВЛІННЯ ЮСТИЦІЇ М.ЗАПОРІЖЖЯ",
    "edrpou": '1235546',
    "short_name": "ЖОВТНЕВЕ РУЮ М.ЗАПОРІЖЖЯ",
    "company_type": "ДЕРЖАВНА ОРГАНІЗАЦІЯ (УСТАНОВА, ЗАКЛАД)",
    "bylaw": "діє на підставі установчих документів, затверджених засновниками (учасниками)",
    "status": "припинено",
    "authority": "Департамент реєстраційних послуг Запорізької міської ради",
  },
  {
    "id": 1857820,
    "name": "ЗАПОРІЗЬКА ГРОМАДСЬКА ОРГАНІЗАЦІЯ \"ПО ЗАХИСТУ ПРАВ ТВАРИН\" - КІНОЛОГІЧНИЙ ЦЕНТР",
    "edrpou": '1235546',
    "short_name": "ЗГО КІНОЛОГІЧНИЙ ЦЕНТР",
    "company_type": "ГРОМАДСЬКА ОРГАНІЗАЦІЯ",
    "bylaw": "діє на підставі установчих документів, затверджених засновниками (учасниками)",
    "status": "припинено",
    "authority": "Департамент реєстраційних послуг Запорізької міської ради",
  },
  {
    "id": 1857821,
    "name": "ГРОМАДСЬКА ОРГАНІЗАЦІЯ ІНВАЛІДІВ ДИТИНСТВА І ЗАГАЛЬНОГО ЗАХВОРЮВАННЯ \"ПРОГРЕС\"",
    "edrpou": '1235546',
    "short_name": "ГОІДІЗЗ \"ПРОГРЕС\"",
    "company_type": "ГРОМАДСЬКА ОРГАНІЗАЦІЯ",
    "bylaw": "діє на підставі установчих документів, затверджених засновниками (учасниками)",
    "status": "зареєстровано",
    "authority": "Департамент реєстраційних послуг Запорізької міської ради",
  },
  {
    "id": 1857822,
    "name": "ПРИВАТНЕ ПІДПРИЄМСТВО \"ЮМА\"",
    "edrpou": '1235546',
    "short_name": null,
    "company_type": "ПРИВАТНЕ ПІДПРИЄМСТВО",
    "bylaw": "діє на підставі установчих документів, затверджених засновниками (учасниками)",
    "status": "припинено",
    "authority": "Департамент реєстраційних послуг Запорізької міської ради",
  },
  {
    "id": 1857823,
    "name": "ПРИВАТНЕ ПІДПРИЄМСТВО \"КАРОЛІНА\"",
    "edrpou": '1235546',
    "short_name": null,
    "company_type": "ПРИВАТНЕ ПІДПРИЄМСТВО",
    "bylaw": "діє на підставі установчих документів, затверджених засновниками (учасниками)",
    "status": "припинено",
    "authority": "Департамент реєстраційних послуг Запорізької міської ради",
  },
  {
    "id": 1857824,
    "name": "ПРИВАТНЕ ПІДПРИЄМСТВО \"ПЕРФЕКТ\"",
    "edrpou": '1235546',
    "short_name": null,
    "company_type": "ПРИВАТНЕ ПІДПРИЄМСТВО",
    "bylaw": "діє на підставі установчих документів, затверджених засновниками (учасниками)",
    "status": "припинено",
    "authority": "Департамент реєстраційних послуг Запорізької міської ради",
  },
  {
    "id": 1857825,
    "name": "ТОВАРИСТВО З ОБМЕЖЕНОЮ ВІДПОВІДАЛЬНІСТЮ \"АРТ ДЕКОР\"",
    "edrpou": '1235546',
    "short_name": "ТОВ \"АРТ ДЕКОР\"",
    "company_type": "ТОВАРИСТВО З ОБМЕЖЕНОЮ ВІДПОВІДАЛЬНІСТЮ",
    "bylaw": "діє на підставі установчих документів, затверджених засновниками (учасниками)",
    "status": "припинено",
    "authority": "Департамент реєстраційних послуг Запорізької міської ради",
  },
];

let nodes = [];
let links = [];

function parseNodesLinks(data) {
  let nodes = [];
  let links = [];

  let first = true;

  function recursive(node) {
    if (first) {
      node._opened = true;
      node._root = true;
      first = false;
    }
    if (node.founder_of) {
      node.founder_of.forEach((item) => {
        item._opened = false;
        recursive(item);
        links.push({
          source: node.id,
          target: item.id,
          id: `${node.id}-${item.id}`,
        });
      });
    }
    delete node.founder_of;
    nodes.push(node);
  }

  recursive(data);

  return [nodes, links];
}


function pushIfNotExists(array, newItem) {
  const res = array.find(item => item.id === newItem.id);
  if (!res) {
    array.push(newItem);
    return true;
  }
  return false;
}


$('#company-search-btn').on('click', function () {
  const $button = $(this);
  $button.prop('disabled', true);
  const edrpou = $('input#company-search').val();
  const params = new URLSearchParams();
  params.set('edrpou', edrpou);
  fetch(`https://ipa.dataocean.us/api/company/?${params.toString()}`)
    .then((response) => {
      $button.prop('disabled', false);
      response.json().then(function (data) {
        [nodes, links] = parseNodesLinks(data.results[0]);
        update();
      });
    })
    .catch((err) => {
      $button.attr('disable', false);
    });
});


const width = 1000;
const height = 600;
const colors = {
  primary: '#3FA2F7',
  secondary: '#ADBCD9',
  root: '#4F4F4F',
};

let i = 0;

const transform = d3.zoomIdentity;
let node, link;

const svg = d3.select('#graph').append('svg')
  .attr('height', height)
  // .attr('width', width)
  // .attr('height', '100%')
  .attr('width', '100%')
  .attr('viewBox', '0 0 1000 600')
  // .style('border', '1px solid #666')
  // .style('border-radius', '10px')
  .call(d3.zoom()
    // .scaleExtent([1 / 2, 8])
    .on('zoom', zoomed)
  )
  .append('g');

svg.append("defs").selectAll("marker")
  .data(["end"])      // Different link/path types can be defined here
  .enter().append("svg:marker")    // This section adds in the arrows
  .attr("id", String)
  .attr("viewBox", "0 -5 10 10")
  .attr("refX", 15)
  .attr("refY", -1.5)
  .attr("markerWidth", 6)
  .attr("markerHeight", 6)
  .attr("orient", "auto")
  .append("svg:path")
  .attr("d", "M0,-5L10,0L0,5");

const linksG = svg.append("g").attr("class", "links");
const nodesG = svg.append("g").attr("class", "nodes");
// .attr('transform', 'translate(40,0)');


const simulation = d3.forceSimulation()
  .force('link', d3.forceLink().id((d) => d.id).distance(150))
  .force('charge', d3.forceManyBody().strength(-100))
  .force('center', d3.forceCenter(width / 2, height / 2))
  .alphaDecay(0.001)
  .on('tick', ticked);


// const root = d3.hierarchy(data, );
// let [nodes, links] = parseNodesLinks(data);

function update(source) {
  // const nodes = flatten(root);
  // const links = root.links();
  // debugger
  link = linksG
    .selectAll('.link')
    .data(links, function (d) { return d.id; });

  link.exit().remove();

  const linkEnter = link
      .enter()
      // .attr("class", "link")
      // .attr("marker-end", "url(#end)");
      .append('line')
      .attr('class', 'link')
      .style('stroke', colors.secondary)
      .style('opacity', 0)
      .style('stroke-width', 1)
    // .on('mouseenter', lineHover)
    // .on('mouseleave', lineBlur);
  ;

  addTransition(linkEnter, 1000);

  link = linkEnter.merge(link);

  node = nodesG
    .selectAll('.node')
    .data(nodes, d => d.id);

  node.exit().remove();

  const nodeEnter = node
    .enter()
    .append('g')
    .attr('class', 'node')
    .style('opacity', 0)
    .style('stroke', nodeDefaultColor)
    .style('fill', nodeDefaultColor)
    .on('mouseenter', nodeHover)
    .on('mouseleave', nodeBlur)
    .call(d3.drag()
      .on('start', dragstarted)
      .on('drag', dragged)
      .on('end', dragended));

  addTransition(nodeEnter);

  nodeEnter.append('circle')
    .attr("r", (d) => d._root ? 32 : 24)
    .style('cursor', 'pointer')
    // .style('stroke', )
    .style('stroke-width', 2)
    .style('fill', '#fff')
    .on('click', nodeClick);

  nodeEnter.append('rect')
    .attr('hidden', hideCount)
    .attr('x', -7)
    .attr('y', -32)
    .attr('width', 14)
    .attr('height', 14)
    .attr('rx', 4)
    .attr('ry', 4)
    .attr('class', 'child-count')
    .style('stroke-width', 0)
    // .style('fill', '#3FA2F7')
    .style('cursor', 'pointer')
    .on('click', countClick);

  // nodeEnter.append('image')
  //   .attr('xlink:href', 'static/icons/build1.svg')
  //   .attr('x', -16)
  //   .attr('y', -18)

  nodeEnter.append('svg')
    .attr('x', (d) => d._root ? -22 : -16)
    .attr('y', (d) => d._root ? -24 : -18)
    .style('cursor', 'pointer')
    .on('click', nodeClick)
    .append('g')
    // .attr('width', (d) => d._root ? 40 : 32)
    // .attr('heigth', (d) => d._root ? 40 : 32)
    // .attr('viewBox', '0 0 40 40')
    .attr('transform', (d) => d._root ? 'scale(1.4)' : null)
    .append('path')
    .attr('fill-rule', "evenodd")
    .attr('clip-rule', "evenodd")
    .attr('d', (d) => {
      // return 'M15.5 1H16.7V1.59998H20.9L19.7 3.09998L20.9 4.59998H16.7V6.16H15.5V4.59998V1.59998V1ZM3 ' +
      //   '14C4.3 10.134 11.4203 7 16 7C20.5797 7 27.7 10.134 29 14H3ZM7.5 16H3.5V28H7.5V16ZM9.5 ' +
      //   '16H12.5V24H9.5V16ZM24.5 16H28.5V28H24.5V16ZM14.5 24V16H17.5V24H14.5ZM22.5 ' +
      //   '16H19.5V24H22.5V16ZM9.5 28V26H22.5V28H9.5Z'
      return 'M20 3H12V5H8V7H6V29H13V24H19V29H26V7H24V5H20V3ZM15 ' +
        '9H10V12H15V9ZM10 14H15V17H10V14ZM15 19H10V22H15V19ZM22 ' +
        '9H17V12H22V9ZM17 14H22V17H17V14ZM22 19H17V22H22V19Z';
    })
    // .attr('fill', '#3FA2F7')
    .attr('stroke-width', 0);

  nodeEnter.append('text')
    .attr('hidden', hideCount)
    // TODO: replace text hardcode
    .text((d) => d.founder_of_count || 0)
    .attr('class', 'child-count')
    .attr('x', 0)
    .attr('y', -22)
    .style('stroke-width', 0)
    .style('stroke', '#fff')
    .style('fill', '#fff')
    .style('text-anchor', 'middle')
    .style('font-size', 10)
    .style('cursor', 'pointer')
    .on('click', countClick);

  svg.selectAll('.child-count')
    .style('display', (d) => d.children && d.children.length ? "none" : undefined);

  node = nodeEnter.merge(node);
  simulation.nodes(nodes);
  simulation.force('link').links(links);

  d3.selectAll('svg .node').each(function (d, i) {
    $(this).popover({
      trigger: 'hover',
      title: d.name,
      placement: 'top',
      html: true,
      content: `<div class="company-name">${d.short_name || d.name}</div>` +
        `<div>${d.company_type || ''}</div>` +
        `<div>ЄДРПОУ ${d.edrpou || ''}</div>` +
        `<div>Статус: ${d.status || ''}</div>`,
      template: '<div class="popover" role="tooltip">' +
        // '<div class="arrow"></div>' +
        // '<h3 class="popover-header"></h3>' +
        '<div class="popover-body popover-primary"></div>' +
        '</div>'
    });
  });
}

function addTransition(d, delay = 0) {
  d.transition()
    .delay(delay)
    .duration(1000)
    .ease(d3.easeLinear)
    .style("opacity", 1);
}

function hideCount(d) {
  return d._opened ? true : null;
}

function sizeContain(num) {
  num = num > 1000 ? num / 1000 : num / 100;
  if (num < 4) num = 4;
  return num;
}

function radius(d) {
  return d._children ? 8
    : d.children ? 8
      : 4;
}

function ticked() {
  link
    .attr('x1', (d) => d.source.x)
    .attr('y1', (d) => d.source.y)
    .attr('x2', (d) => d.target.x)
    .attr('y2', (d) => d.target.y);

  // link.attr("d", function (d) {
  //   let dx = d.target.x - d.source.x;
  //   let dy = d.target.y - d.source.y;
  //   let dr = Math.sqrt(dx * dx + dy * dy);
  //   return "M" +
  //     d.source.x + "," +
  //     d.source.y + "A" +
  //     dr + "," + dr + " 0 0,1 " +
  //     d.target.x + "," +
  //     d.target.y;
  // });

  node
    .attr('transform', (d) => {
      return `translate(${d.x}, ${d.y})`;
    });
}

function nodeClick(d) {
  svg.selectAll('.node')
    .style('stroke', nodeDefaultColor)
    .style('fill', nodeDefaultColor);

  d3.select(this.closest('g'))
    .style('fill', colors.primary)
    .style('stroke', colors.primary);

  svg.selectAll('line')
    .style('stroke', (d_link) => {
      return d_link.source.id === d.id ? colors.primary : colors.secondary;
    })
    .style('stroke-width', (d_link) => {
      return d_link.source.id === d.id ? 2 : 1;
    });


  fetch(`https://ipa.dataocean.us/api/company/${d.id}/`)
    .then((response) => {
      if (response.status !== 200) {
        console.log('Error ', response.status);
        return;
      }
      response.json().then((data) => {
        const $data = $('#company-detail');
        $data.find('.detail__name, .detail__prop').remove();

        const d_elem = (text, css_class = 'detail__prop') => {
          if (!text) {
            return '';
          }
          return `<div class="${css_class}">${text}</div>`;
        };

        $data.append([
          d_elem(data.name, 'detail__name'),
          d_elem(data.short_name),
          d_elem(`Статус ${data.status}`),
          d_elem(`ЄДРПОУ ${data.edrpou}`),
          d_elem(`Адреса ${data.address || ''}`),
          d_elem(data.bylaw),
        ]);
      });
    })
    .catch((error) => {
      debugger
    });

  // Object.entries(d).forEach(([key, value]) => {
  //   if (key === 'children') return;
  //   $data.append(
  //     `<tr><td>${key}</td><td>${value}</td></tr>`
  //   );
  // });
}

function nodeDefaultColor(d) {
  return d._root ? colors.root : colors.secondary;
}

function nodeHover(d) {
  if (!d3.event.defaultPrevented) {
    d3.select(this).select('circle')
      .style('fill', '#EBF6FE');
  }
}

function nodeBlur(d) {
  if (!d3.event.defaultPrevented) {
    d3.select(this).select('circle')
      .style('fill', '#fff');
  }
}

function lineHover(d) {
  if (!d3.event.defaultPrevented) {
    d3.select(this)
      .style('stroke-width', 2)
      .style('stroke', colors.primary);
  }
}

function lineBlur(d) {
  if (!d3.event.defaultPrevented) {
    d3.select(this)
      .style('stroke-width', 1)
      .style('stroke', colors.secondary);
  }
}


function increaseSimulationSpeed() {
  simulation.alpha(0.01);
  let a = 0.1;
  let int = setInterval(() => {
    if (a === 0.7) {
      clearInterval(int);
      return;
    }
    simulation.alpha(a);
    a += 0.1;
  }, 100);

}


function countClick(d) {

  if (!d3.event.defaultPrevented) {
    // if (d.children) {
    //   d._children = d.children;
    //   d.children = null;
    // } else {
    //   d.children = d._children;
    //   d._children = null;
    // }
    // let newNode = d3.hierarchy(additionalData1);
    // let newNodes = additionalData1.map((item) => {
    //   let newNode = d3.hierarchy(item);
    //   newNode.depth = d.depth + 1;
    //   newNode.height = d.height - 1;
    //   newNode.parent = d;
    //   newNode.x = d.x;
    //   newNode.y = d.y;
    //   return newNode;
    // });

    fetch(`https://ipa.dataocean.us/api/company/${d.id}/`)
      .then((response) => {
        response.json().then((data) => {
          increaseSimulationSpeed();
          data.founder_of.forEach((newNode) => {
            newNode._opened = false;
            const isNew = pushIfNotExists(nodes, newNode);
            if (isNew) {
              newNode.x = d.x;
              newNode.y = d.y;
            }
            links.push({
              source: d.id,
              target: newNode.id,
              id: `${d.id}-${newNode.id}`
            });

            let node = nodes.find((item) => item.id === d.id);
            node._opened = true;
            svg.selectAll('.child-count')
              .attr('hidden', hideCount);

            update(d);
          });
        });
      });

    // let newNodes = additionalData1.map((newNode) => {
    //   newNode._opened = false;
    //   const isNew = pushIfNotExists(nodes, newNode);
    //   if (isNew) {
    //     newNode.x = d.x;
    //     newNode.y = d.y;
    //   }
    //   links.push({
    //     source: d.id,
    //     target: newNode.id,
    //     id: `${d.id}-${newNode.id}`
    //   });
    //   // node._opened = true;
    // });
    //
    // // d.children = newNodes;
    // // d.data.children = newNodes.data;
    // update(d);
  }
}


function dragstarted(d) {
  if (!d3.event.active) simulation.alphaTarget(0.3).restart();
  d.fx = d.x;
  d.fy = d.y;
}

function dragged(d) {
  d.fx = d3.event.x;
  d.fy = d3.event.y;
}

function dragended(d) {
  if (!d3.event.active) simulation.alphaTarget(0);
  d.fx = null;
  d.fy = null;
}

function flatten(root) {
  const nodes = [];

  function recurse(node) {
    if (node.children) node.children.forEach(recurse);
    if (!node.id) node.id = ++i;
    else ++i;
    nodes.push(node);
  }

  recurse(root);
  return nodes;
}

function zoomed() {
  svg.attr('transform', d3.event.transform);
}

update();
